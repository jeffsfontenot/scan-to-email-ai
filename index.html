<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1a3a5c">
  <meta name="description" content="Scan documents, extract text with AI, and email summaries">
  <title>Scan to Email AI</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-blue: #2d5f8d;
      --accent-cyan: #00d9ff;
      --dark-bg: #0a1929;
      --card-bg: #132f4c;
      --text-primary: #ffffff;
      --text-secondary: #b2bac2;
      --success: #66bb6a;
      --error: #ef5350;
      --warning: #ffa726;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: var(--dark-bg);
      color: var(--text-primary);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('background.png') center/cover;
      opacity: 0.15;
      z-index: 0;
      pointer-events: none;
    }

    #root {
      position: relative;
      z-index: 1;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      padding-bottom: 100px;
    }

    /* Splash Screen */
    .splash-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #0a1929 0%, #1a3a5c 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeOut 0.5s ease 2s forwards;
    }

    @keyframes fadeOut {
      to {
        opacity: 0;
        pointer-events: none;
      }
    }

    .splash-logo {
      width: 200px;
      height: 200px;
      margin-bottom: 20px;
      animation: pulse 2s ease infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); filter: drop-shadow(0 0 20px rgba(0, 217, 255, 0.5)); }
      50% { transform: scale(1.05); filter: drop-shadow(0 0 40px rgba(0, 217, 255, 0.8)); }
    }

    .splash-text {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--accent-cyan);
      text-shadow: 0 0 20px rgba(0, 217, 255, 0.5);
    }

    /* Header */
    .app-header {
      text-align: center;
      padding: 30px 20px;
      background: linear-gradient(135deg, rgba(26, 58, 92, 0.5) 0%, rgba(19, 47, 76, 0.5) 100%);
      border-radius: 20px;
      margin-bottom: 30px;
      border: 1px solid rgba(0, 217, 255, 0.2);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .app-logo {
      width: 80px;
      height: 80px;
      margin: 0 auto 15px;
      filter: drop-shadow(0 0 10px rgba(0, 217, 255, 0.3));
    }

    .app-header h1 {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent-cyan);
      margin-bottom: 8px;
      text-shadow: 0 0 20px rgba(0, 217, 255, 0.3);
    }

    .app-header p {
      color: var(--text-secondary);
      font-size: 1rem;
    }

    /* Navigation */
    .nav-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      background: rgba(19, 47, 76, 0.5);
      padding: 8px;
      border-radius: 12px;
      border: 1px solid rgba(0, 217, 255, 0.1);
    }

    .nav-tab {
      flex: 1;
      padding: 12px;
      background: transparent;
      color: var(--text-secondary);
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    .nav-tab.active {
      background: linear-gradient(135deg, var(--primary-blue), var(--accent-cyan));
      color: white;
      box-shadow: 0 4px 12px rgba(0, 217, 255, 0.3);
    }

    .nav-tab:hover:not(.active) {
      background: rgba(0, 217, 255, 0.1);
      color: var(--accent-cyan);
    }

    /* Cards */
    .card {
      background: linear-gradient(135deg, rgba(26, 58, 92, 0.4) 0%, rgba(19, 47, 76, 0.4) 100%);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      border: 1px solid rgba(0, 217, 255, 0.2);
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 32px rgba(0, 217, 255, 0.2);
      border-color: rgba(0, 217, 255, 0.4);
    }

    .card h2 {
      font-size: 1.25rem;
      margin-bottom: 16px;
      color: var(--accent-cyan);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-icon {
      font-size: 1.5rem;
    }

    /* Buttons */
    .btn {
      width: 100%;
      padding: 14px 24px;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-family: inherit;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.1), transparent);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .btn:hover::before {
      opacity: 1;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-blue), var(--accent-cyan));
      color: white;
      box-shadow: 0 4px 12px rgba(0, 217, 255, 0.3);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 217, 255, 0.5);
    }

    .btn-secondary {
      background: rgba(0, 217, 255, 0.1);
      color: var(--accent-cyan);
      border: 1px solid rgba(0, 217, 255, 0.3);
    }

    .btn-secondary:hover:not(:disabled) {
      background: rgba(0, 217, 255, 0.2);
      border-color: var(--accent-cyan);
    }

    .btn-danger {
      background: rgba(239, 83, 80, 0.2);
      color: var(--error);
      border: 1px solid rgba(239, 83, 80, 0.3);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Input Fields */
    .input-group {
      margin-bottom: 16px;
    }

    .input-label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-secondary);
      font-size: 0.9rem;
      font-weight: 500;
    }

    .input-field {
      width: 100%;
      padding: 12px 16px;
      background: rgba(0, 217, 255, 0.05);
      border: 1px solid rgba(0, 217, 255, 0.2);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 1rem;
      font-family: inherit;
      transition: all 0.3s ease;
    }

    .input-field:focus {
      outline: none;
      border-color: var(--accent-cyan);
      background: rgba(0, 217, 255, 0.1);
      box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.1);
    }

    .input-field::placeholder {
      color: var(--text-secondary);
    }

    /* Image Preview */
    .image-preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .image-item {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      aspect-ratio: 1;
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid rgba(0, 217, 255, 0.2);
      transition: all 0.3s ease;
    }

    .image-item:hover {
      border-color: var(--accent-cyan);
      transform: scale(1.05);
    }

    .image-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .image-badge {
      position: absolute;
      top: 8px;
      left: 8px;
      background: rgba(0, 217, 255, 0.9);
      color: var(--dark-bg);
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .remove-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(239, 83, 80, 0.9);
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      font-weight: bold;
    }

    .remove-btn:hover {
      transform: scale(1.15);
      background: var(--error);
    }

    /* Status Messages */
    .status {
      padding: 14px 16px;
      border-radius: 10px;
      margin-top: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 0.95rem;
      animation: slideIn 0.3s ease;
      border: 1px solid;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .status.processing {
      background: rgba(0, 217, 255, 0.1);
      border-color: rgba(0, 217, 255, 0.3);
      color: var(--accent-cyan);
    }

    .status.success {
      background: rgba(102, 187, 106, 0.1);
      border-color: rgba(102, 187, 106, 0.3);
      color: var(--success);
    }

    .status.error {
      background: rgba(239, 83, 80, 0.1);
      border-color: rgba(239, 83, 80, 0.3);
      color: var(--error);
    }

    .status.warning {
      background: rgba(255, 167, 38, 0.1);
      border-color: rgba(255, 167, 38, 0.3);
      color: var(--warning);
    }

    /* Spinner */
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Progress Bar */
    .progress-container {
      margin-top: 16px;
    }

    .progress-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(0, 217, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      border: 1px solid rgba(0, 217, 255, 0.2);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-blue), var(--accent-cyan));
      border-radius: 4px;
      transition: width 0.3s ease;
      box-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
    }

    /* Email List */
    .email-list {
      margin-top: 12px;
    }

    .email-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      background: rgba(0, 217, 255, 0.05);
      border: 1px solid rgba(0, 217, 255, 0.2);
      border-radius: 8px;
      margin-bottom: 8px;
      transition: all 0.3s ease;
    }

    .email-item:hover {
      background: rgba(0, 217, 255, 0.1);
      border-color: var(--accent-cyan);
    }

    .email-text {
      color: var(--text-primary);
      font-size: 0.95rem;
      flex: 1;
    }

    .email-remove {
      background: none;
      border: none;
      color: var(--error);
      cursor: pointer;
      font-size: 1.2rem;
      padding: 4px 8px;
      transition: all 0.2s ease;
    }

    .email-remove:hover {
      transform: scale(1.2);
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Hidden Input */
    .file-input {
      display: none;
    }

    /* Summary Preview */
    .summary-preview {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(0, 217, 255, 0.2);
      border-radius: 10px;
      padding: 16px;
      margin-top: 16px;
      max-height: 400px;
      overflow-y: auto;
    }

    .summary-section {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(0, 217, 255, 0.1);
    }

    .summary-section:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .summary-header {
      font-size: 1.1rem;
      color: var(--accent-cyan);
      font-weight: 600;
      margin-bottom: 8px;
    }

    .summary-text {
      color: var(--text-secondary);
      font-size: 0.95rem;
      line-height: 1.6;
    }

    /* Offline indicator */
    .offline-banner {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: var(--warning);
      color: var(--dark-bg);
      padding: 10px;
      text-align: center;
      font-weight: 600;
      z-index: 1000;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        transform: translateY(-100%);
      }
      to {
        transform: translateY(0);
      }
    }

    /* Responsive */
    @media (max-width: 640px) {
      .app-header h1 {
        font-size: 1.5rem;
      }
      
      .app-logo {
        width: 60px;
        height: 60px;
      }
      
      #root {
        padding: 16px;
      }
      
      .card {
        padding: 20px;
      }

      .image-preview {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      }
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(0, 217, 255, 0.3);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 217, 255, 0.5);
    }
  </style>
</head>
<body>
  <!-- Splash Screen -->
  <div class="splash-screen" id="splashScreen">
    <img src="icon-512.png" alt="Logo" class="splash-logo">
    <div class="splash-text">SCAN to EMAIL AI</div>
  </div>

  <div id="root"></div>

  <!-- Dependencies -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const { Document, Packer, Paragraph, TextRun, HeadingLevel } = docx;

    function App() {
      const [currentTab, setCurrentTab] = useState('scan');
      const [images, setImages] = useState([]);
      const [recipientEmails, setRecipientEmails] = useState([]);
      const [newEmail, setNewEmail] = useState('');
      const [emailSubject, setEmailSubject] = useState('Document Summaries - {date}');
      const [emailBody, setEmailBody] = useState('Please find attached the document summaries generated by Scan to Email AI.');
      const [status, setStatus] = useState(null);
      const [progress, setProgress] = useState(0);
      const [progressStep, setProgressStep] = useState('');
      const [summaries, setSummaries] = useState([]);
      const [isOnline, setIsOnline] = useState(navigator.onLine);
      const [queuedDoc, setQueuedDoc] = useState(null);
      const fileInputRef = useRef(null);

      // Load settings from localStorage
      useEffect(() => {
        const savedEmails = localStorage.getItem('recipientEmails');
        const savedSubject = localStorage.getItem('emailSubject');
        const savedBody = localStorage.getItem('emailBody');
        
        if (savedEmails) setRecipientEmails(JSON.parse(savedEmails));
        if (savedSubject) setEmailSubject(savedSubject);
        if (savedBody) setEmailBody(savedBody);

        // Hide splash screen
        setTimeout(() => {
          document.getElementById('splashScreen').style.display = 'none';
        }, 2000);
      }, []);

      // Monitor online status
      useEffect(() => {
        const handleOnline = () => setIsOnline(true);
        const handleOffline = () => setIsOnline(false);
        
        window.addEventListener('online', handleOnline);
        window.addEventListener('offline', handleOffline);
        
        return () => {
          window.removeEventListener('online', handleOnline);
          window.removeEventListener('offline', handleOffline);
        };
      }, []);

      // Save settings
      useEffect(() => {
        localStorage.setItem('recipientEmails', JSON.stringify(recipientEmails));
      }, [recipientEmails]);

      useEffect(() => {
        localStorage.setItem('emailSubject', emailSubject);
      }, [emailSubject]);

      useEffect(() => {
        localStorage.setItem('emailBody', emailBody);
      }, [emailBody]);

      const handleImageSelect = (e) => {
        const files = Array.from(e.target.files);
        const imageFiles = files.filter(file => file.type.startsWith('image/'));
        
        const newImages = imageFiles.map(file => ({
          file,
          url: URL.createObjectURL(file),
          id: Math.random().toString(36),
          enhanced: false
        }));
        
        setImages(prev => [...prev, ...newImages]);
      };

      const removeImage = (id) => {
        setImages(prev => prev.filter(img => img.id !== id));
      };

      const clearAllImages = () => {
        setImages([]);
        setSummaries([]);
        setStatus(null);
        setProgress(0);
      };

      const enhanceImage = async (imageFile) => {
        return new Promise((resolve) => {
          const img = new Image();
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          
          img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            
            // Draw image
            ctx.drawImage(img, 0, 0);
            
            // Get image data
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Enhance: increase contrast and brightness
            for (let i = 0; i < data.length; i += 4) {
              // Increase contrast
              data[i] = ((data[i] - 128) * 1.3) + 128;     // Red
              data[i + 1] = ((data[i + 1] - 128) * 1.3) + 128; // Green
              data[i + 2] = ((data[i + 2] - 128) * 1.3) + 128; // Blue
              
              // Increase brightness slightly
              data[i] += 15;
              data[i + 1] += 15;
              data[i + 2] += 15;
              
              // Clamp values
              data[i] = Math.min(255, Math.max(0, data[i]));
              data[i + 1] = Math.min(255, Math.max(0, data[i + 1]));
              data[i + 2] = Math.min(255, Math.max(0, data[i + 2]));
            }
            
            ctx.putImageData(imageData, 0, 0);
            
            canvas.toBlob((blob) => {
              resolve(new File([blob], imageFile.name, { type: 'image/png' }));
            }, 'image/png');
          };
          
          img.src = URL.createObjectURL(imageFile);
        });
      };

      const processImages = async () => {
        if (images.length === 0) {
          setStatus({ type: 'error', message: '‚ùå Please add at least one image' });
          return;
        }

        if (recipientEmails.length === 0) {
          setStatus({ type: 'error', message: '‚ùå Please add at least one recipient email in Settings' });
          return;
        }

        if (!isOnline) {
          setStatus({ type: 'warning', message: '‚ö†Ô∏è You are offline. AI summarization requires internet connection.' });
          return;
        }

        try {
          setProgress(0);
          setProgressStep('Starting...');
          setStatus({ type: 'processing', message: 'üîÑ Processing images...' });

          // Step 1: Enhance images
          setProgressStep('Enhancing images...');
          const enhancedImages = [];
          for (let i = 0; i < images.length; i++) {
            setProgress(((i + 1) / images.length) * 15);
            const enhanced = await enhanceImage(images[i].file);
            enhancedImages.push({ ...images[i], enhancedFile: enhanced });
          }
          
          setProgress(15);
          setProgressStep('Extracting text from images...');
          setStatus({ type: 'processing', message: 'üìÑ Extracting text with OCR...' });

          // Step 2: OCR on enhanced images
          const ocrResults = [];
          for (let i = 0; i < enhancedImages.length; i++) {
            setProgress(15 + ((i + 1) / enhancedImages.length) * 25);
            setProgressStep(`Reading image ${i + 1} of ${enhancedImages.length}...`);
            
            const result = await Tesseract.recognize(
              enhancedImages[i].enhancedFile,
              'eng',
              {
                logger: m => {
                  if (m.status === 'recognizing text') {
                    console.log(`OCR Progress: ${Math.round(m.progress * 100)}%`);
                  }
                }
              }
            );
            
            ocrResults.push({
              text: result.data.text,
              imageId: enhancedImages[i].id
            });
          }

          setProgress(40);
          setProgressStep('Detecting document headers...');
          setStatus({ type: 'processing', message: 'üîç Detecting document headers...' });

          // Step 3: Detect headers and group
          const groups = detectAndGroupByHeaders(ocrResults);
          
          if (groups.length === 0) {
            setStatus({ 
              type: 'warning', 
              message: '‚ö†Ô∏è No document headers detected. Processing all text as one document.' 
            });
            groups.push({
              header: 'Document',
              text: ocrResults.map(r => r.text).join(' ')
            });
          }

          setProgress(45);
          setProgressStep('Generating AI summaries...');
          setStatus({ type: 'processing', message: 'ü§ñ Generating AI summaries...' });

          // Step 4: Summarize with Claude
          const groupSummaries = [];
          for (let i = 0; i < groups.length; i++) {
            setProgress(45 + ((i + 1) / groups.length) * 35);
            setProgressStep(`Summarizing ${groups[i].header} (${i + 1}/${groups.length})...`);
            
            const summary = await summarizeWithClaude(groups[i].text);
            groupSummaries.push({
              header: groups[i].header,
              summary: summary
            });
          }

          setSummaries(groupSummaries);
          setProgress(80);
          setProgressStep('Creating Word document...');
          setStatus({ type: 'processing', message: 'üìù Creating Word document...' });

          // Step 5: Create Word document
          const docBlob = await createWordDocument(groupSummaries);
          setProgress(90);

          setProgressStep('Preparing email...');
          setStatus({ type: 'processing', message: 'üìß Opening email client...' });

          // Step 6: Open default email app
          await openEmailWithAttachment(docBlob);
          setProgress(100);
          setProgressStep('Complete!');

          setStatus({ 
            type: 'success', 
            message: '‚úÖ Document created! Your email app should open shortly.' 
          });

        } catch (error) {
          console.error('Processing error:', error);
          setStatus({ 
            type: 'error', 
            message: `‚ùå Error: ${error.message}. Please try again.` 
          });
          setProgress(0);
          setProgressStep('');
        }
      };

      const detectAndGroupByHeaders = (ocrResults) => {
        const groups = [];
        let currentGroup = null;

        // Pattern: N followed by optional space, then 1-5 digits, then 1-3 letters
        const headerPattern = /^N\s*\d{1,5}[A-Z]{1,3}/im;

        ocrResults.forEach(result => {
          const lines = result.text.split('\n');
          
          lines.forEach(line => {
            const trimmedLine = line.trim();
            if (!trimmedLine) return;

            const headerMatch = trimmedLine.match(headerPattern);
            
            if (headerMatch) {
              // Start new group
              if (currentGroup && currentGroup.text.trim()) {
                groups.push(currentGroup);
              }
              currentGroup = {
                header: headerMatch[0].replace(/\s+/g, ''),
                text: ''
              };
            } else if (currentGroup) {
              // Add to current group
              currentGroup.text += trimmedLine + ' ';
            } else {
              // No header yet, start accumulating
              if (!currentGroup) {
                currentGroup = {
                  header: 'Document',
                  text: trimmedLine + ' '
                };
              }
            }
          });
        });

        // Add last group
        if (currentGroup && currentGroup.text.trim()) {
          groups.push(currentGroup);
        }

        return groups;
      };

      const summarizeWithClaude = async (text) => {
        try {
          const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              model: "claude-sonnet-4-20250514",
              max_tokens: 1500,
              messages: [
                { 
                  role: "user", 
                  content: `Please provide a detailed summary of the following document text. Include all key information, important details, dates, numbers, and relevant facts. Make it comprehensive but well-organized:\n\n${text}` 
                }
              ],
            })
          });

          if (!response.ok) {
            throw new Error('API request failed');
          }

          const data = await response.json();
          
          if (data.content && data.content[0] && data.content[0].text) {
            return data.content[0].text;
          } else {
            throw new Error('Invalid API response');
          }
        } catch (error) {
          console.error('Claude API error:', error);
          throw new Error('AI summarization failed. Please check your internet connection.');
        }
      };

      const createWordDocument = async (summaries) => {
        const children = [];

        // Title
        children.push(
          new Paragraph({
            text: "Document Summaries",
            heading: HeadingLevel.HEADING_1,
            spacing: { after: 400 }
          })
        );

        // Date
        const now = new Date();
        children.push(
          new Paragraph({
            children: [
              new TextRun({
                text: `Generated: ${now.toLocaleString()}`,
                size: 20,
                color: "666666"
              })
            ],
            spacing: { after: 400 }
          })
        );

        // Each group
        summaries.forEach((item, index) => {
          // Header
          children.push(
            new Paragraph({
              children: [
                new TextRun({
                  text: item.header,
                  bold: true,
                  size: 32,
                  color: "2d5f8d"
                })
              ],
              spacing: { before: 300, after: 150 }
            })
          );

          // Summary
          children.push(
            new Paragraph({
              children: [
                new TextRun({
                  text: item.summary,
                  size: 24
                })
              ],
              spacing: { after: 300 }
            })
          );
        });

        const doc = new Document({
          sections: [{
            properties: {
              page: {
                size: {
                  width: 12240,
                  height: 15840
                },
                margin: { 
                  top: 1440, 
                  right: 1440, 
                  bottom: 1440, 
                  left: 1440 
                }
              }
            },
            children: children
          }]
        });

        const blob = await Packer.toBlob(doc);
        return blob;
      };

      const openEmailWithAttachment = async (docBlob) => {
        // Save file for attachment
        const fileName = `document-summaries-${new Date().toISOString().split('T')[0]}.docx`;
        
        // Create downloadable file
        saveAs(docBlob, fileName);

        // Prepare email
        const recipients = recipientEmails.join(',');
        const subject = emailSubject.replace('{date}', new Date().toLocaleDateString());
        const body = encodeURIComponent(emailBody);

        // Create mailto link
        const mailtoLink = `mailto:${recipients}?subject=${encodeURIComponent(subject)}&body=${body}`;

        // Open default email client
        setTimeout(() => {
          window.location.href = mailtoLink;
        }, 1000);

        // Show instructions
        setTimeout(() => {
          setStatus({
            type: 'success',
            message: `‚úÖ Document downloaded as "${fileName}". Please attach it to the email that just opened.`
          });
        }, 2000);
      };

      const addEmail = () => {
        const email = newEmail.trim().toLowerCase();
        
        if (!email) return;
        
        // Basic email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          setStatus({ type: 'error', message: '‚ùå Please enter a valid email address' });
          return;
        }
        
        if (recipientEmails.includes(email)) {
          setStatus({ type: 'warning', message: '‚ö†Ô∏è Email already in list' });
          return;
        }
        
        setRecipientEmails([...recipientEmails, email]);
        setNewEmail('');
        setStatus({ type: 'success', message: '‚úÖ Email added' });
      };

      const removeEmail = (email) => {
        setRecipientEmails(recipientEmails.filter(e => e !== email));
      };

      return (
        <>
          {!isOnline && (
            <div className="offline-banner">
              ‚ö†Ô∏è You are offline - AI features unavailable
            </div>
          )}

          <div className="app-header">
            <img src="icon-192.png" alt="App Logo" className="app-logo" />
            <h1>SCAN to EMAIL AI</h1>
            <p>Document processing powered by AI</p>
          </div>

          <div className="nav-tabs">
            <button 
              className={`nav-tab ${currentTab === 'scan' ? 'active' : ''}`}
              onClick={() => setCurrentTab('scan')}
            >
              üì∑ Scan
            </button>
            <button 
              className={`nav-tab ${currentTab === 'settings' ? 'active' : ''}`}
              onClick={() => setCurrentTab('settings')}
            >
              ‚öôÔ∏è Settings
            </button>
          </div>

          {currentTab === 'scan' && (
            <>
              {/* Image Capture */}
              <div className="card">
                <h2><span className="card-icon">üì∏</span> Capture Images</h2>
                <input
                  ref={fileInputRef}
                  type="file"
                  accept="image/*"
                  multiple
                  capture="environment"
                  onChange={handleImageSelect}
                  className="file-input"
                />
                <button 
                  className="btn btn-primary"
                  onClick={() => fileInputRef.current.click()}
                >
                  <span>üì∑</span>
                  {images.length === 0 ? 'Take or Select Photos' : `Add More Photos (${images.length})`}
                </button>

                {images.length > 0 && (
                  <>
                    <div className="image-preview">
                      {images.map((img, idx) => (
                        <div key={img.id} className="image-item">
                          <img src={img.url} alt={`Preview ${idx + 1}`} />
                          <div className="image-badge">#{idx + 1}</div>
                          <button 
                            className="remove-btn"
                            onClick={() => removeImage(img.id)}
                          >
                            √ó
                          </button>
                        </div>
                      ))}
                    </div>
                    <button 
                      className="btn btn-danger"
                      onClick={clearAllImages}
                      style={{ marginTop: '12px' }}
                    >
                      üóëÔ∏è Clear All
                    </button>
                  </>
                )}
              </div>

              {/* Process Button */}
              <div className="card">
                <h2><span className="card-icon">üöÄ</span> Process Documents</h2>
                <button 
                  className="btn btn-primary"
                  onClick={processImages}
                  disabled={status?.type === 'processing' || images.length === 0}
                >
                  {status?.type === 'processing' ? (
                    <>
                      <div className="spinner" />
                      Processing...
                    </>
                  ) : (
                    <>
                      <span>‚ö°</span>
                      Process & Email
                    </>
                  )}
                </button>

                {status && (
                  <div className={`status ${status.type}`}>
                    {status.type === 'processing' && <div className="spinner" />}
                    {status.message}
                  </div>
                )}

                {progress > 0 && (
                  <div className="progress-container">
                    <div className="progress-info">
                      <span>{progressStep}</span>
                      <span>{Math.round(progress)}%</span>
                    </div>
                    <div className="progress-bar">
                      <div className="progress-fill" style={{ width: `${progress}%` }} />
                    </div>
                  </div>
                )}
              </div>

              {/* Summary Preview */}
              {summaries.length > 0 && (
                <div className="card">
                  <h2><span className="card-icon">üìÑ</span> Summary Preview</h2>
                  <div className="summary-preview">
                    {summaries.map((item, idx) => (
                      <div key={idx} className="summary-section">
                        <div className="summary-header">{item.header}</div>
                        <div className="summary-text">{item.summary}</div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </>
          )}

          {currentTab === 'settings' && (
            <>
              {/* Recipient Emails */}
              <div className="card">
                <h2><span className="card-icon">üìß</span> Recipient Emails</h2>
                <div className="input-group">
                  <label className="input-label">Add Email Address</label>
                  <input
                    type="email"
                    className="input-field"
                    placeholder="recipient@example.com"
                    value={newEmail}
                    onChange={(e) => setNewEmail(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && addEmail()}
                  />
                  <button 
                    className="btn btn-primary"
                    onClick={addEmail}
                    style={{ marginTop: '8px' }}
                  >
                    ‚ûï Add Email
                  </button>
                </div>

                <div className="email-list">
                  {recipientEmails.length === 0 ? (
                    <div className="empty-state">
                      <div className="empty-state-icon">üì≠</div>
                      <p>No recipient emails configured</p>
                    </div>
                  ) : (
                    recipientEmails.map((email, idx) => (
                      <div key={idx} className="email-item">
                        <span className="email-text">{email}</span>
                        <button 
                          className="email-remove"
                          onClick={() => removeEmail(email)}
                        >
                          √ó
                        </button>
                      </div>
                    ))
                  )}
                </div>
              </div>

              {/* Email Template */}
              <div className="card">
                <h2><span className="card-icon">‚úâÔ∏è</span> Email Template</h2>
                <div className="input-group">
                  <label className="input-label">Subject Line (use {'{date}'} for current date)</label>
                  <input
                    type="text"
                    className="input-field"
                    value={emailSubject}
                    onChange={(e) => setEmailSubject(e.target.value)}
                  />
                </div>
                <div className="input-group">
                  <label className="input-label">Email Body</label>
                  <textarea
                    className="input-field"
                    rows="4"
                    value={emailBody}
                    onChange={(e) => setEmailBody(e.target.value)}
                  />
                </div>
              </div>

              {/* App Info */}
              <div className="card">
                <h2><span className="card-icon">‚ÑπÔ∏è</span> About</h2>
                <p style={{ color: 'var(--text-secondary)', lineHeight: '1.6' }}>
                  <strong>Scan to Email AI v1.0</strong><br />
                  This app uses OCR and AI to extract and summarize text from document images.
                  Documents are automatically grouped by detected headers (e.g., N109DR, N813DG).
                  <br /><br />
                  <strong>How it works:</strong><br />
                  1. Capture or select document images<br />
                  2. Images are enhanced and processed with OCR<br />
                  3. AI generates detailed summaries<br />
                  4. Word document is created and downloaded<br />
                  5. Default email app opens with pre-filled recipients
                </p>
              </div>
            </>
          )}
        </>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(reg => console.log('‚úÖ Service Worker registered'))
          .catch(err => console.log('‚ùå Service Worker registration failed', err));
      });
    }
  </script>
</body>
</html>
